{"ast":null,"code":"import _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport _initializerDefineProperty from \"@babel/runtime/helpers/initializerDefineProperty\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/inherits\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/getPrototypeOf\";\nimport _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nimport _applyDecoratedDescriptor from \"@babel/runtime/helpers/applyDecoratedDescriptor\";\nimport _initializerWarningHelper from \"@babel/runtime/helpers/initializerWarningHelper\";\n\nvar _dec, _dec2, _dec3, _dec4, _dec5, _dec6, _dec7, _dec8, _dec9, _dec10, _dec11, _dec12, _dec13, _dec14, _dec15, _dec16, _class, _class2, _descriptor, _descriptor2, _descriptor3, _descriptor4, _descriptor5, _descriptor6, _descriptor7, _descriptor8, _descriptor9, _descriptor10, _descriptor11, _descriptor12, _descriptor13, _descriptor14, _descriptor15;\n\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\n\nfunction _createSuper(Derived) {\n  var hasNativeReflectConstruct = _isNativeReflectConstruct();\n\n  return function _createSuperInternal() {\n    var Super = _getPrototypeOf(Derived),\n        result;\n\n    if (hasNativeReflectConstruct) {\n      var NewTarget = _getPrototypeOf(this).constructor;\n\n      result = Reflect.construct(Super, arguments, NewTarget);\n    } else {\n      result = Super.apply(this, arguments);\n    }\n\n    return _possibleConstructorReturn(this, result);\n  };\n}\n\nfunction _isNativeReflectConstruct() {\n  if (typeof Reflect === \"undefined\" || !Reflect.construct) return false;\n  if (Reflect.construct.sham) return false;\n  if (typeof Proxy === \"function\") return true;\n\n  try {\n    Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {}));\n    return true;\n  } catch (e) {\n    return false;\n  }\n}\n\nimport { AsyncParallelHook } from '@antv/async-hook';\nimport { $window, DOM } from '@antv/l7-utils';\nimport elementResizeEvent, { unbind } from 'element-resize-event';\nimport { EventEmitter } from 'eventemitter3';\nimport { inject, injectable } from 'inversify';\nimport 'reflect-metadata';\nimport { TYPES } from '../../types';\nimport { createRendererContainer } from '../../utils/dom';\nimport { InteractionEvent } from '../interaction/IInteractionService';\nvar Scene = (_dec = injectable(), _dec2 = inject(TYPES.SceneID), _dec3 = inject(TYPES.IIconService), _dec4 = inject(TYPES.IFontService), _dec5 = inject(TYPES.IControlService), _dec6 = inject(TYPES.IGlobalConfigService), _dec7 = inject(TYPES.IMapService), _dec8 = inject(TYPES.ICoordinateSystemService), _dec9 = inject(TYPES.IRendererService), _dec10 = inject(TYPES.ILayerService), _dec11 = inject(TYPES.ICameraService), _dec12 = inject(TYPES.IInteractionService), _dec13 = inject(TYPES.IPickingService), _dec14 = inject(TYPES.IShaderModuleService), _dec15 = inject(TYPES.IMarkerService), _dec16 = inject(TYPES.IPopupService), _dec(_class = (_class2 = function (_EventEmitter) {\n  _inherits(Scene, _EventEmitter);\n\n  var _super = _createSuper(Scene);\n\n  function Scene() {\n    var _this;\n\n    _classCallCheck(this, Scene);\n\n    _this = _super.call(this);\n\n    _defineProperty(_assertThisInitialized(_this), \"destroyed\", false);\n\n    _defineProperty(_assertThisInitialized(_this), \"loaded\", false);\n\n    _defineProperty(_assertThisInitialized(_this), \"loadFont\", false);\n\n    _defineProperty(_assertThisInitialized(_this), \"fontFamily\", '');\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"id\", _descriptor, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"iconService\", _descriptor2, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"fontService\", _descriptor3, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"controlService\", _descriptor4, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"configService\", _descriptor5, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"map\", _descriptor6, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"coordinateSystemService\", _descriptor7, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"rendererService\", _descriptor8, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"layerService\", _descriptor9, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"cameraService\", _descriptor10, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"interactionService\", _descriptor11, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"pickingService\", _descriptor12, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"shaderModuleService\", _descriptor13, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"markerService\", _descriptor14, _assertThisInitialized(_this));\n\n    _initializerDefineProperty(_assertThisInitialized(_this), \"popupService\", _descriptor15, _assertThisInitialized(_this));\n\n    _defineProperty(_assertThisInitialized(_this), \"inited\", false);\n\n    _defineProperty(_assertThisInitialized(_this), \"initPromise\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"rendering\", false);\n\n    _defineProperty(_assertThisInitialized(_this), \"$container\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"canvas\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"markerContainer\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"hooks\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"handleWindowResized\", function () {\n      _this.emit('resize');\n\n      if (_this.$container) {\n        _this.initContainer();\n\n        DOM.triggerResize();\n        _this.coordinateSystemService.needRefresh = true;\n\n        _this.render();\n      }\n    });\n\n    _defineProperty(_assertThisInitialized(_this), \"handleMapCameraChanged\", function (viewport) {\n      _this.cameraService.update(viewport);\n\n      _this.render();\n    });\n\n    _this.hooks = {\n      init: new AsyncParallelHook()\n    };\n    return _this;\n  }\n\n  _createClass(Scene, [{\n    key: \"init\",\n    value: function init(sceneConfig) {\n      var _this2 = this;\n\n      this.configService.setSceneConfig(this.id, sceneConfig);\n      this.shaderModuleService.registerBuiltinModules();\n      this.iconService.init();\n      this.iconService.on('imageUpdate', function () {\n        return _this2.render();\n      });\n      this.fontService.init();\n      this.hooks.init.tapPromise('initMap', _asyncToGenerator(_regeneratorRuntime.mark(function _callee() {\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return new Promise(function (resolve) {\n                  _this2.map.onCameraChanged(function (viewport) {\n                    _this2.cameraService.init();\n\n                    _this2.cameraService.update(viewport);\n\n                    if (_this2.map.version !== 'GAODE2.x') {\n                      resolve();\n                    }\n                  });\n\n                  if (_this2.map.version !== 'GAODE2.x') {\n                    _this2.map.init();\n                  } else {\n                    resolve();\n                  }\n                });\n\n              case 2:\n                if (!(_this2.map.version === 'GAODE2.x' && _this2.map.initViewPort)) {\n                  _context.next = 6;\n                  break;\n                }\n\n                _context.next = 5;\n                return _this2.map.init();\n\n              case 5:\n                _this2.map.initViewPort();\n\n              case 6:\n                _this2.map.onCameraChanged(_this2.handleMapCameraChanged);\n\n                _this2.map.addMarkerContainer();\n\n                _this2.markerService.addMarkers();\n\n                _this2.markerService.addMarkerLayers();\n\n                _this2.popupService.initPopup();\n\n                _this2.interactionService.init();\n\n                _this2.interactionService.on(InteractionEvent.Drag, _this2.addSceneEvent.bind(_this2));\n\n              case 13:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee);\n      })));\n      this.hooks.init.tapPromise('initRenderer', _asyncToGenerator(_regeneratorRuntime.mark(function _callee2() {\n        var $container, _$window$matchMedia;\n\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                $container = createRendererContainer(_this2.configService.getSceneConfig(_this2.id).id || '');\n                _this2.$container = $container;\n\n                if (!$container) {\n                  _context2.next = 11;\n                  break;\n                }\n\n                _this2.canvas = DOM.create('canvas', '', $container);\n\n                _this2.setCanvas();\n\n                _context2.next = 7;\n                return _this2.rendererService.init(_this2.canvas, _this2.configService.getSceneConfig(_this2.id));\n\n              case 7:\n                elementResizeEvent(_this2.$container, _this2.handleWindowResized);\n\n                if ($window.matchMedia) {\n                  (_$window$matchMedia = $window.matchMedia('screen and (-webkit-min-device-pixel-ratio: 1.5)')) === null || _$window$matchMedia === void 0 ? void 0 : _$window$matchMedia.addListener(_this2.handleWindowResized);\n                }\n\n                _context2.next = 12;\n                break;\n\n              case 11:\n                console.error('容器 id 不存在');\n\n              case 12:\n                _this2.pickingService.init(_this2.id);\n\n              case 13:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      })));\n      this.initPromise = this.hooks.init.promise();\n      this.render();\n    }\n  }, {\n    key: \"initMiniScene\",\n    value: function initMiniScene(sceneConfig) {\n      var _this3 = this;\n\n      this.configService.setSceneConfig(this.id, sceneConfig);\n      this.shaderModuleService.registerBuiltinModules();\n      this.iconService.init();\n      this.iconService.on('imageUpdate', function () {\n        return _this3.render();\n      });\n      this.fontService.init();\n      this.hooks.init.tapPromise('initMap', _asyncToGenerator(_regeneratorRuntime.mark(function _callee3() {\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.next = 2;\n                return new Promise(function (resolve) {\n                  _this3.map.onCameraChanged(function (viewport) {\n                    _this3.cameraService.init();\n\n                    _this3.cameraService.update(viewport);\n\n                    if (_this3.map.version !== 'GAODE2.x') {\n                      resolve();\n                    }\n                  });\n\n                  _this3.map.initMiniMap();\n                });\n\n              case 2:\n                _this3.map.onCameraChanged(_this3.handleMapCameraChanged);\n\n                _this3.interactionService.init();\n\n                _this3.interactionService.on(InteractionEvent.Drag, _this3.addSceneEvent.bind(_this3));\n\n              case 5:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3);\n      })));\n      this.hooks.init.tapPromise('initRenderer', _asyncToGenerator(_regeneratorRuntime.mark(function _callee4() {\n        var $container;\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                $container = sceneConfig.canvas;\n                _this3.$container = $container ? $container : null;\n\n                if (!_this3.$container) {\n                  _context4.next = 7;\n                  break;\n                }\n\n                _context4.next = 5;\n                return _this3.rendererService.init(sceneConfig.canvas, _this3.configService.getSceneConfig(_this3.id));\n\n              case 5:\n                _context4.next = 8;\n                break;\n\n              case 7:\n                console.error('容器 id 不存在');\n\n              case 8:\n                _this3.pickingService.init(_this3.id);\n\n              case 9:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4);\n      })));\n      this.initPromise = this.hooks.init.promise();\n      this.render();\n    }\n  }, {\n    key: \"addLayer\",\n    value: function addLayer(layer) {\n      this.layerService.sceneService = this;\n      this.layerService.add(layer);\n      this.render();\n    }\n  }, {\n    key: \"render\",\n    value: function () {\n      var _render = _asyncToGenerator(_regeneratorRuntime.mark(function _callee5() {\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                if (!(this.rendering || this.destroyed)) {\n                  _context5.next = 2;\n                  break;\n                }\n\n                return _context5.abrupt(\"return\");\n\n              case 2:\n                this.rendering = true;\n\n                if (this.inited) {\n                  _context5.next = 15;\n                  break;\n                }\n\n                _context5.next = 6;\n                return this.initPromise;\n\n              case 6:\n                if (this.destroyed) {\n                  this.destroy();\n                }\n\n                if (!(this.loadFont && document.fonts)) {\n                  _context5.next = 10;\n                  break;\n                }\n\n                _context5.next = 10;\n                return document.fonts.load(\"24px \".concat(this.fontFamily), 'L7text');\n\n              case 10:\n                this.layerService.initLayers();\n                this.controlService.addControls();\n                this.loaded = true;\n                this.emit('loaded');\n                this.inited = true;\n\n              case 15:\n                this.layerService.updateLayerRenderList();\n                this.layerService.renderLayers();\n                this.rendering = false;\n\n              case 18:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5, this);\n      }));\n\n      function render() {\n        return _render.apply(this, arguments);\n      }\n\n      return render;\n    }()\n  }, {\n    key: \"addFontFace\",\n    value: function addFontFace(fontFamily, fontPath) {\n      this.fontFamily = fontFamily;\n      var style = document.createElement('style');\n      style.type = 'text/css';\n      style.innerText = \"\\n        @font-face{\\n            font-family: '\".concat(fontFamily, \"';\\n            src: url('\").concat(fontPath, \"') format('woff2'),\\n            url('\").concat(fontPath, \"') format('woff'),\\n            url('\").concat(fontPath, \"') format('truetype');\\n        }\");\n      document.getElementsByTagName('head')[0].appendChild(style);\n      this.loadFont = true;\n    }\n  }, {\n    key: \"getSceneContainer\",\n    value: function getSceneContainer() {\n      return this.$container;\n    }\n  }, {\n    key: \"exportPng\",\n    value: function exportPng(type) {\n      var _this$$container;\n\n      var renderCanvas = (_this$$container = this.$container) === null || _this$$container === void 0 ? void 0 : _this$$container.getElementsByTagName('canvas')[0];\n      this.render();\n      var layersPng = type === 'jpg' ? renderCanvas === null || renderCanvas === void 0 ? void 0 : renderCanvas.toDataURL('image/jpeg') : renderCanvas === null || renderCanvas === void 0 ? void 0 : renderCanvas.toDataURL('image/png');\n      return layersPng;\n    }\n  }, {\n    key: \"getSceneConfig\",\n    value: function getSceneConfig() {\n      return this.configService.getSceneConfig(this.id);\n    }\n  }, {\n    key: \"getPointSizeRange\",\n    value: function getPointSizeRange() {\n      return this.rendererService.getPointSizeRange();\n    }\n  }, {\n    key: \"addMarkerContainer\",\n    value: function addMarkerContainer() {\n      var mapContainer = this.$container.parentElement;\n\n      if (mapContainer !== null) {\n        this.markerContainer = DOM.create('div', 'l7-marker-container', mapContainer);\n      }\n    }\n  }, {\n    key: \"getMarkerContainer\",\n    value: function getMarkerContainer() {\n      return this.markerContainer;\n    }\n  }, {\n    key: \"destroy\",\n    value: function destroy() {\n      var _this4 = this,\n          _this$$container2,\n          _this$$container2$par;\n\n      if (!this.inited) {\n        this.destroyed = true;\n        return;\n      }\n\n      this.emit('destroy');\n      this.layerService.destroy();\n      setTimeout(function () {\n        _this4.rendererService.destroy();\n      });\n      this.map.destroy();\n      this.interactionService.destroy();\n      this.controlService.destroy();\n      this.markerService.destroy();\n      this.fontService.destroy();\n      this.iconService.destroy();\n      (_this$$container2 = this.$container) === null || _this$$container2 === void 0 ? void 0 : (_this$$container2$par = _this$$container2.parentNode) === null || _this$$container2$par === void 0 ? void 0 : _this$$container2$par.removeChild(this.$container);\n      this.removeAllListeners();\n      this.inited = false;\n      unbind(this.$container, this.handleWindowResized);\n\n      if ($window.matchMedia) {\n        var _$window$matchMedia2;\n\n        (_$window$matchMedia2 = $window.matchMedia('screen and (min-resolution: 2dppx)')) === null || _$window$matchMedia2 === void 0 ? void 0 : _$window$matchMedia2.removeListener(this.handleWindowResized);\n      }\n    }\n  }, {\n    key: \"initContainer\",\n    value: function initContainer() {\n      var _this$$container3, _this$$container4;\n\n      var pixelRatio = DOM.DPR;\n      var w = ((_this$$container3 = this.$container) === null || _this$$container3 === void 0 ? void 0 : _this$$container3.clientWidth) || 400;\n      var h = ((_this$$container4 = this.$container) === null || _this$$container4 === void 0 ? void 0 : _this$$container4.clientHeight) || 300;\n      var canvas = this.canvas;\n\n      if (canvas) {\n        canvas.width = w * pixelRatio;\n        canvas.height = h * pixelRatio;\n      }\n\n      this.rendererService.viewport({\n        x: 0,\n        y: 0,\n        width: pixelRatio * w,\n        height: pixelRatio * h\n      });\n    }\n  }, {\n    key: \"setCanvas\",\n    value: function setCanvas() {\n      var _this$$container5, _this$$container6;\n\n      var pixelRatio = DOM.DPR;\n      var w = ((_this$$container5 = this.$container) === null || _this$$container5 === void 0 ? void 0 : _this$$container5.clientWidth) || 400;\n      var h = ((_this$$container6 = this.$container) === null || _this$$container6 === void 0 ? void 0 : _this$$container6.clientHeight) || 300;\n      var canvas = this.canvas;\n      canvas.width = w * pixelRatio;\n      canvas.height = h * pixelRatio;\n      canvas.style.width = '100%';\n      canvas.style.height = '100%';\n    }\n  }, {\n    key: \"addSceneEvent\",\n    value: function addSceneEvent(target) {\n      this.emit(target.type, target);\n    }\n  }]);\n\n  return Scene;\n}(EventEmitter), (_descriptor = _applyDecoratedDescriptor(_class2.prototype, \"id\", [_dec2], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor2 = _applyDecoratedDescriptor(_class2.prototype, \"iconService\", [_dec3], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor3 = _applyDecoratedDescriptor(_class2.prototype, \"fontService\", [_dec4], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor4 = _applyDecoratedDescriptor(_class2.prototype, \"controlService\", [_dec5], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor5 = _applyDecoratedDescriptor(_class2.prototype, \"configService\", [_dec6], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor6 = _applyDecoratedDescriptor(_class2.prototype, \"map\", [_dec7], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor7 = _applyDecoratedDescriptor(_class2.prototype, \"coordinateSystemService\", [_dec8], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor8 = _applyDecoratedDescriptor(_class2.prototype, \"rendererService\", [_dec9], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor9 = _applyDecoratedDescriptor(_class2.prototype, \"layerService\", [_dec10], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor10 = _applyDecoratedDescriptor(_class2.prototype, \"cameraService\", [_dec11], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor11 = _applyDecoratedDescriptor(_class2.prototype, \"interactionService\", [_dec12], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor12 = _applyDecoratedDescriptor(_class2.prototype, \"pickingService\", [_dec13], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor13 = _applyDecoratedDescriptor(_class2.prototype, \"shaderModuleService\", [_dec14], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor14 = _applyDecoratedDescriptor(_class2.prototype, \"markerService\", [_dec15], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor15 = _applyDecoratedDescriptor(_class2.prototype, \"popupService\", [_dec16], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n})), _class2)) || _class);\nexport { Scene as default };","map":null,"metadata":{},"sourceType":"module"}