{"ast":null,"code":"import { __extends } from \"tslib\";\nimport Hierarchy from '@antv/hierarchy';\nimport { each, isObject, isString } from '@antv/util';\nimport Util from '../util';\nimport Graph from './graph';\nvar radialLayout = Util.radialLayout,\n    traverseTree = Util.traverseTree;\n\nvar TreeGraph =\n/** @class */\nfunction (_super) {\n  __extends(TreeGraph, _super);\n\n  function TreeGraph(cfg) {\n    var _this = _super.call(this, cfg) || this;\n\n    _this.layoutAnimating = false; // ç”¨äºç¼“å­˜åŠ¨ç”»ç»“æŸåéœ€è¦åˆ é™¤çš„èŠ‚ç‚¹\n\n    _this.set('removeList', []);\n\n    _this.set('layoutMethod', _this.getLayout());\n\n    return _this;\n  }\n  /**\n   * é€šè¿‡ Layout é…ç½®è·å–å¸ƒå±€é…ç½®\n   */\n\n\n  TreeGraph.prototype.getLayout = function () {\n    var layout = this.get('layout');\n\n    if (!layout) {\n      return null;\n    }\n\n    if (typeof layout === 'function') {\n      return layout;\n    }\n\n    if (!layout.type) {\n      layout.type = 'dendrogram';\n    }\n\n    if (!layout.direction) {\n      layout.direction = 'TB';\n    }\n\n    if (layout.radial) {\n      return function (data) {\n        var layoutData = Hierarchy[layout.type](data, layout);\n        radialLayout(layoutData);\n        return layoutData;\n      };\n    }\n\n    return function (data) {\n      return Hierarchy[layout.type](data, layout);\n    };\n  };\n  /**\n   * è¿”å›æŒ‡å®šèŠ‚ç‚¹åœ¨æ ‘å›¾æ•°æ®ä¸­çš„ç´¢å¼•\n   * @param children æ ‘å›¾æ•°æ®\n   * @param child æ ‘å›¾ä¸­æŸä¸€ä¸ª Item çš„æ•°æ®\n   */\n\n\n  TreeGraph.indexOfChild = function (children, id) {\n    var index = -1; // eslint-disable-next-line consistent-return\n\n    each(children, function (former, i) {\n      if (id === former.id) {\n        index = i;\n        return false;\n      }\n    });\n    return index;\n  };\n\n  TreeGraph.prototype.getDefaultCfg = function () {\n    var cfg = _super.prototype.getDefaultCfg.call(this); // æ ‘å›¾é»˜è®¤æ‰“å¼€åŠ¨ç”»\n\n\n    cfg.animate = true;\n    return cfg;\n  };\n  /**\n   * å‘ğŸŒ²æ ‘ä¸­æ·»åŠ æ•°æ®\n   * @param treeData æ ‘å›¾æ•°æ®\n   * @param parent çˆ¶èŠ‚ç‚¹å®ä¾‹\n   * @param animate æ˜¯å¦å¼€å¯åŠ¨ç”»\n   */\n\n\n  TreeGraph.prototype.innerAddChild = function (treeData, parent, animate) {\n    var self = this;\n    var model = treeData.data;\n\n    if (model) {\n      // model ä¸­åº”å­˜å‚¨çœŸå®çš„æ•°æ®ï¼Œç‰¹åˆ«æ˜¯çœŸå®çš„ children\n      model.x = treeData.x;\n      model.y = treeData.y;\n      model.depth = treeData.depth;\n    }\n\n    var node = self.addItem('node', model, false);\n\n    if (parent) {\n      node.set('parent', parent);\n\n      if (animate) {\n        var origin_1 = parent.get('originAttrs');\n\n        if (origin_1) {\n          node.set('originAttrs', origin_1);\n        } else {\n          var parentModel = parent.getModel();\n          node.set('originAttrs', {\n            x: parentModel.x,\n            y: parentModel.y\n          });\n        }\n      }\n\n      var childrenList = parent.get('children');\n\n      if (!childrenList) {\n        parent.set('children', [node]);\n      } else {\n        childrenList.push(node);\n      }\n\n      self.addItem('edge', {\n        source: parent.get('id'),\n        target: node.get('id'),\n        id: \"\".concat(parent.get('id'), \":\").concat(node.get('id'))\n      }, false);\n    } // æ¸²æŸ“åˆ°è§†å›¾ä¸Šåº”å‚è€ƒå¸ƒå±€çš„children, é¿å…å¤šç»˜åˆ¶äº†æ”¶èµ·çš„èŠ‚ç‚¹\n\n\n    each(treeData.children || [], function (child) {\n      self.innerAddChild(child, node, animate);\n    });\n    self.emit('afteraddchild', {\n      item: node,\n      parent: parent\n    });\n    return node;\n  };\n  /**\n   * å°†æ•°æ®ä¸Šçš„å˜æ›´è½¬æ¢åˆ°è§†å›¾ä¸Š\n   * @param data\n   * @param parent\n   * @param animate\n   */\n\n\n  TreeGraph.prototype.innerUpdateChild = function (data, parent, animate) {\n    var self = this;\n    var current = self.findById(data.id); // è‹¥å­æ ‘ä¸å­˜åœ¨ï¼Œæ•´ä½“æ·»åŠ å³å¯\n\n    if (!current) {\n      self.innerAddChild(data, parent, animate);\n      return;\n    } // æ›´æ–°æ–°èŠ‚ç‚¹ä¸‹æ‰€æœ‰å­èŠ‚ç‚¹\n\n\n    each(data.children || [], function (child) {\n      self.innerUpdateChild(child, current, animate);\n    }); // ç”¨ç°åœ¨èŠ‚ç‚¹çš„childrenå®ä¾‹æ¥åˆ é™¤ç§»é™¤çš„å­èŠ‚ç‚¹\n\n    var children = current.get('children');\n\n    if (children) {\n      var len = children.length;\n\n      if (len > 0) {\n        for (var i = children.length - 1; i >= 0; i--) {\n          var child = children[i].getModel();\n\n          if (TreeGraph.indexOfChild(data.children || [], child.id) === -1) {\n            self.innerRemoveChild(child.id, {\n              x: data.x,\n              y: data.y\n            }, animate); // æ›´æ–°çˆ¶èŠ‚ç‚¹ä¸‹ç¼“å­˜çš„å­èŠ‚ç‚¹ item å®ä¾‹åˆ—è¡¨\n\n            children.splice(i, 1);\n          }\n        }\n      }\n    }\n\n    var oriX;\n    var oriY;\n\n    if (current.get('originAttrs')) {\n      oriX = current.get('originAttrs').x;\n      oriY = current.get('originAttrs').y;\n    }\n\n    var model = current.getModel();\n\n    if (animate) {\n      // å¦‚æœæœ‰åŠ¨ç”»ï¼Œå…ˆç¼“å­˜èŠ‚ç‚¹è¿åŠ¨å†æ›´æ–°èŠ‚ç‚¹\n      current.set('originAttrs', {\n        x: model.x,\n        y: model.y\n      });\n    }\n\n    current.set('model', data.data);\n\n    if (oriX !== data.x || oriY !== data.y) {\n      current.updatePosition({\n        x: data.x,\n        y: data.y\n      });\n    }\n  };\n  /**\n   * åˆ é™¤å­èŠ‚ç‚¹Itemå¯¹è±¡\n   * @param id\n   * @param to\n   * @param animate\n   */\n\n\n  TreeGraph.prototype.innerRemoveChild = function (id, to, animate) {\n    var self = this;\n    var node = self.findById(id);\n\n    if (!node) {\n      return;\n    }\n\n    each(node.get('children'), function (child) {\n      self.innerRemoveChild(child.getModel().id, to, animate);\n    });\n\n    if (animate) {\n      var model = node.getModel();\n      node.set('to', to);\n      node.set('originAttrs', {\n        x: model.x,\n        y: model.y\n      });\n      self.get('removeList').push(node);\n    } else {\n      self.removeItem(node, false);\n    }\n  };\n  /**\n   * æ›´æ–°æ•°æ®æ¨¡å‹ï¼Œå·®é‡æ›´æ–°å¹¶é‡æ–°æ¸²æŸ“\n   * @param {object} data æ•°æ®æ¨¡å‹\n   */\n\n\n  TreeGraph.prototype.changeData = function (data) {\n    var self = this; // æ›´æ”¹æ•°æ®æºåï¼Œå–æ¶ˆæ‰€æœ‰çŠ¶æ€\n\n    this.getNodes().map(function (node) {\n      return self.clearItemStates(node);\n    });\n    this.getEdges().map(function (edge) {\n      return self.clearItemStates(edge);\n    });\n\n    if (data) {\n      self.data(data);\n      self.render();\n    } else {\n      self.layout(this.get('fitView'));\n    }\n  };\n  /**\n   * å·²æ›´åä¸º updateLayoutï¼Œä¸ºä¿æŒå…¼å®¹æš‚ä¸”ä¿ç•™ã€‚\n   * æ›´æ”¹å¹¶åº”ç”¨æ ‘å¸ƒå±€ç®—æ³•\n   * @param {object} layout å¸ƒå±€ç®—æ³•\n   */\n\n\n  TreeGraph.prototype.changeLayout = function (layout) {\n    // eslint-disable-next-line no-console\n    console.warn('Please call updateLayout instead of changeLayout. changeLayout will be discarded soon');\n    var self = this;\n    self.updateLayout(layout);\n  };\n  /**\n   * æ›´æ”¹å¹¶åº”ç”¨æ ‘å¸ƒå±€ç®—æ³•\n   * @param {object} layout å¸ƒå±€ç®—æ³•\n   */\n\n\n  TreeGraph.prototype.updateLayout = function (layout) {\n    var self = this;\n\n    if (!layout) {\n      // eslint-disable-next-line no-console\n      console.warn('layout cannot be null');\n      return;\n    }\n\n    self.set('layout', layout);\n    self.set('layoutMethod', self.getLayout());\n    self.layout();\n  };\n  /**\n   * å·²æ›´åä¸º layoutï¼Œä¸ºä¿æŒå…¼å®¹æš‚ä¸”ä¿ç•™ã€‚\n   * æ ¹æ®ç›®å‰çš„ data åˆ·æ–°å¸ƒå±€ï¼Œæ›´æ–°åˆ°ç”»å¸ƒä¸Šã€‚ç”¨äºå˜æ›´æ•°æ®ä¹‹ååˆ·æ–°è§†å›¾ã€‚\n   * @param {boolean} fitView æ›´æ–°å¸ƒå±€æ—¶æ˜¯å¦éœ€è¦é€‚åº”çª—å£\n   */\n\n\n  TreeGraph.prototype.refreshLayout = function (fitView) {\n    // eslint-disable-next-line no-console\n    console.warn('Please call layout instead of refreshLayout. refreshLayout will be discarded soon');\n    var self = this;\n    self.layout(fitView);\n  };\n  /**\n   * æ ¹æ®ç›®å‰çš„ data åˆ·æ–°å¸ƒå±€ï¼Œæ›´æ–°åˆ°ç”»å¸ƒä¸Šã€‚ç”¨äºå˜æ›´æ•°æ®ä¹‹ååˆ·æ–°è§†å›¾ã€‚\n   * @param {boolean} fitView æ›´æ–°å¸ƒå±€æ—¶æ˜¯å¦éœ€è¦é€‚åº”çª—å£\n   */\n\n\n  TreeGraph.prototype.layout = function (fitView) {\n    var self = this;\n    var data = self.get('data');\n    var layoutMethod = self.get('layoutMethod');\n    var layoutData = layoutMethod ? layoutMethod(data, self.get('layout')) : data;\n    var animate = self.get('animate');\n    self.emit('beforerefreshlayout', {\n      data: data,\n      layoutData: layoutData\n    });\n    self.emit('beforelayout');\n    self.innerUpdateChild(layoutData, undefined, animate);\n\n    if (fitView) {\n      var viewController = self.get('viewController');\n      viewController.fitView();\n    }\n\n    if (!animate) {\n      // å¦‚æœæ²¡æœ‰åŠ¨ç”»ï¼Œç›®å‰ä»…æ›´æ–°äº†èŠ‚ç‚¹çš„ä½ç½®ï¼Œåˆ·æ–°ä¸€ä¸‹è¾¹çš„æ ·å¼\n      self.refresh();\n      self.paint();\n    } else {\n      self.layoutAnimate(layoutData);\n    }\n\n    self.emit('afterrefreshlayout', {\n      data: data,\n      layoutData: layoutData\n    });\n    self.emit('afterlayout');\n  };\n  /**\n   * æ·»åŠ å­æ ‘åˆ°å¯¹åº” id çš„èŠ‚ç‚¹\n   * @param {TreeGraphData} data å­æ ‘æ•°æ®æ¨¡å‹\n   * @param {string} parent å­æ ‘çš„çˆ¶èŠ‚ç‚¹id\n   */\n\n\n  TreeGraph.prototype.addChild = function (data, parent) {\n    var self = this;\n    self.emit('beforeaddchild', {\n      model: data,\n      parent: parent\n    }); // å°†æ•°æ®æ·»åŠ åˆ°æºæ•°æ®ä¸­ï¼Œèµ°changeDataæ–¹æ³•\n\n    if (!isString(parent)) {\n      parent = parent.get('id');\n    }\n\n    var parentData = self.findDataById(parent);\n\n    if (parentData) {\n      if (!parentData.children) {\n        parentData.children = [];\n      }\n\n      parentData.children.push(data);\n      self.changeData();\n    }\n  };\n  /**\n   * æ›´æ–°æŸä¸ªèŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­èŠ‚ç‚¹\n   * @param {TreeGraphData[]} data å­æ ‘æ•°æ®æ¨¡å‹é›†åˆ\n   * @param {string} parent å­æ ‘çš„çˆ¶èŠ‚ç‚¹id\n   */\n\n\n  TreeGraph.prototype.updateChildren = function (data, parentId) {\n    var self = this; // å¦‚æœæ²¡æœ‰çˆ¶èŠ‚ç‚¹æˆ–æ‰¾ä¸åˆ°è¯¥èŠ‚ç‚¹ï¼Œæ˜¯å…¨é‡çš„æ›´æ–°ï¼Œç›´æ¥é‡ç½®data\n\n    if (!parentId || !self.findById(parentId)) {\n      console.warn(\"Update children failed! There is no node with id '\".concat(parentId, \"'\"));\n      return;\n    }\n\n    var parentModel = self.findDataById(parentId);\n    parentModel.children = data;\n    self.changeData();\n  };\n  /**\n   * æ›´æ–°æºæ•°æ®ï¼Œå·®é‡æ›´æ–°å­æ ‘\n   * @param {TreeGraphData} data å­æ ‘æ•°æ®æ¨¡å‹\n   * @param {string} parentId å­æ ‘çš„çˆ¶èŠ‚ç‚¹id\n   */\n\n\n  TreeGraph.prototype.updateChild = function (data, parentId) {\n    var self = this; // å¦‚æœæ²¡æœ‰çˆ¶èŠ‚ç‚¹æˆ–æ‰¾ä¸åˆ°è¯¥èŠ‚ç‚¹ï¼Œæ˜¯å…¨é‡çš„æ›´æ–°ï¼Œç›´æ¥é‡ç½®data\n\n    if (!parentId || !self.findById(parentId)) {\n      self.changeData(data);\n      return;\n    }\n\n    var parentModel = self.findDataById(parentId);\n    var current = self.findById(data.id);\n\n    if (!parentModel.children) {\n      // å½“ current ä¸å­˜åœ¨æ—¶ï¼Œchildren ä¸ºç©ºæ•°ç»„\n      parentModel.children = [];\n    } // å¦‚æœä¸å­˜åœ¨è¯¥èŠ‚ç‚¹ï¼Œåˆ™æ·»åŠ \n\n\n    if (!current) {\n      parentModel.children.push(data);\n    } else {\n      var index = TreeGraph.indexOfChild(parentModel.children, data.id);\n      parentModel.children[index] = data;\n    }\n\n    self.changeData();\n  };\n  /**\n   * åˆ é™¤å­æ ‘\n   * @param {string} id å­æ ‘æ ¹èŠ‚ç‚¹id\n   */\n\n\n  TreeGraph.prototype.removeChild = function (id) {\n    var self = this;\n    var node = self.findById(id);\n\n    if (!node) {\n      return;\n    }\n\n    var parent = node.get('parent');\n\n    if (parent && !parent.destroyed) {\n      var parentNode = self.findDataById(parent.get('id'));\n      var siblings = parentNode && parentNode.children || [];\n      var model = node.getModel();\n      var index = TreeGraph.indexOfChild(siblings, model.id);\n      siblings.splice(index, 1);\n    }\n\n    self.changeData();\n  };\n  /**\n   * æ ¹æ®idè·å–å¯¹åº”çš„æºæ•°æ®\n   * @param {string} id å…ƒç´ id\n   * @param {TreeGraphData | undefined} parent ä»å“ªä¸ªèŠ‚ç‚¹å¼€å§‹å¯»æ‰¾ï¼Œä¸ºç©ºæ—¶ä»æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾\n   * @return {TreeGraphData} å¯¹åº”æºæ•°æ®\n   */\n\n\n  TreeGraph.prototype.findDataById = function (id, parent) {\n    var self = this;\n\n    if (!parent) {\n      parent = self.get('data');\n    }\n\n    if (id === parent.id) {\n      return parent;\n    }\n\n    var result = null; // eslint-disable-next-line consistent-return\n\n    each(parent.children || [], function (child) {\n      if (child.id === id) {\n        result = child;\n        return false;\n      }\n\n      result = self.findDataById(id, child);\n\n      if (result) {\n        return false;\n      }\n    });\n    return result;\n  };\n  /**\n   * å¸ƒå±€åŠ¨ç”»æ¥å£ï¼Œç”¨äºæ•°æ®æ›´æ–°æ—¶åšèŠ‚ç‚¹ä½ç½®æ›´æ–°çš„åŠ¨ç”»\n   * @param {TreeGraphData} data æ›´æ–°çš„æ•°æ®\n   * @param {function} onFrame å®šä¹‰èŠ‚ç‚¹ä½ç½®æ›´æ–°æ—¶å¦‚ä½•ç§»åŠ¨\n   */\n\n\n  TreeGraph.prototype.layoutAnimate = function (data, onFrame) {\n    var self = this;\n    var animateCfg = this.get('animateCfg');\n    self.emit('beforeanimate', {\n      data: data\n    }); // å¦‚æœè¾¹ä¸­æ²¡æœ‰æŒ‡å®šé”šç‚¹ï¼Œä½†æ˜¯æœ¬èº«æœ‰é”šç‚¹æ§åˆ¶ï¼Œåœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­ä¿æŒé”šç‚¹ä¸å˜\n\n    self.getEdges().forEach(function (edge) {\n      var model = edge.get('model');\n\n      if (!model.sourceAnchor) {\n        model.sourceAnchor = edge.get('sourceAnchorIndex');\n      }\n    });\n    this.get('canvas').animate(function (ratio) {\n      traverseTree(data, function (child) {\n        var node = self.findById(child.id); // åªæœ‰å½“å­˜åœ¨nodeçš„æ—¶å€™æ‰æ‰§è¡Œ\n\n        if (node) {\n          var origin_2 = node.get('originAttrs');\n          var model = node.get('model');\n\n          if (!origin_2) {\n            origin_2 = {\n              x: model.x,\n              y: model.y\n            };\n            node.set('originAttrs', origin_2);\n          }\n\n          if (onFrame) {\n            var attrs = onFrame(node, ratio, origin_2, data);\n            node.set('model', Object.assign(model, attrs));\n          } else {\n            model.x = origin_2.x + (child.x - origin_2.x) * ratio;\n            model.y = origin_2.y + (child.y - origin_2.y) * ratio;\n          }\n        }\n\n        return true;\n      });\n      each(self.get('removeList'), function (node) {\n        var model = node.getModel();\n        var from = node.get('originAttrs');\n        var to = node.get('to');\n        model.x = from.x + (to.x - from.x) * ratio;\n        model.y = from.y + (to.y - from.y) * ratio;\n      });\n      self.refreshPositions();\n    }, {\n      duration: animateCfg.duration,\n      easing: animateCfg.ease,\n      callback: function callback() {\n        each(self.getNodes(), function (node) {\n          node.set('originAttrs', null);\n        });\n        each(self.get('removeList'), function (node) {\n          self.removeItem(node);\n        });\n        self.set('removeList', []);\n\n        if (animateCfg.callback) {\n          animateCfg.callback();\n        }\n\n        self.emit('afteranimate', {\n          data: data\n        });\n      },\n      delay: animateCfg.delay\n    });\n  };\n  /**\n   * ç«‹å³åœæ­¢å¸ƒå±€åŠ¨ç”»\n   */\n\n\n  TreeGraph.prototype.stopLayoutAnimate = function () {\n    this.get('canvas').stopAnimate();\n    this.emit('layoutanimateend', {\n      data: this.get('data')\n    });\n    this.layoutAnimating = false;\n  };\n  /**\n   * æ˜¯å¦åœ¨å¸ƒå±€åŠ¨ç”»\n   * @return {boolean} æ˜¯å¦æœ‰å¸ƒå±€åŠ¨ç”»\n   */\n\n\n  TreeGraph.prototype.isLayoutAnimating = function () {\n    return this.layoutAnimating;\n  };\n  /**\n   * æ ¹æ®dataæ¥å£çš„æ•°æ®æ¸²æŸ“è§†å›¾\n   */\n\n\n  TreeGraph.prototype.render = function () {\n    var self = this;\n    var data = self.get('data');\n\n    if (!data || !isObject(data) || !Object.keys(data).length) {\n      throw new Error('data must be defined first');\n    }\n\n    self.clear();\n    self.emit('beforerender');\n    self.layout(this.get('fitView'));\n    self.emit('afterrender');\n  };\n  /**\n   * å¯¼å‡ºå›¾æ•°æ®\n   * @return {object} data\n   */\n\n\n  TreeGraph.prototype.save = function () {\n    return this.get('data');\n  };\n\n  return TreeGraph;\n}(Graph);\n\nexport default TreeGraph;","map":null,"metadata":{},"sourceType":"module"}