{"ast":null,"code":"import { each, isString } from '@antv/util';\nvar timer = null;\n\nvar StateController =\n/** @class */\nfunction () {\n  function StateController(graph) {\n    this.graph = graph;\n    /**\n     * this.cachedStates = {\n     *    enabled: {\n     *        hover: [Node]\n     *    },\n     *     disabled: {}\n     *  }\n     */\n\n    this.cachedStates = {\n      enabled: {},\n      disabled: {}\n    };\n    this.destroyed = false;\n  }\n  /**\n   * 检查 cache 的可用性\n   *\n   * @private\n   * @param {Item} item\n   * @param {string} state\n   * @param {object} cache\n   * @returns\n   * @memberof State\n   */\n\n\n  StateController.checkCache = function (item, state, cache) {\n    if (!cache[state]) {\n      return;\n    }\n\n    var index = cache[state].indexOf(item);\n\n    if (index >= 0) {\n      cache[state].splice(index, 1);\n    }\n  };\n  /**\n   * 缓存 state\n   *\n   * @private\n   * @param {Item} item Item 实例\n   * @param {string} state 状态名称\n   * @param {object} states\n   * @memberof State\n   */\n\n\n  StateController.cacheState = function (item, state, states) {\n    if (!states[state]) {\n      states[state] = [];\n    }\n\n    states[state].push(item);\n  };\n  /**\n   * 更新 Item 的状态\n   *\n   * @param {Item} item Item实例\n   * @param {string} state 状态名称\n   * @param {boolean} enabled 状态是否可用\n   * @memberof State\n   */\n\n\n  StateController.prototype.updateState = function (item, state, enabled) {\n    var _this = this;\n\n    var checkCache = StateController.checkCache,\n        cacheState = StateController.cacheState;\n\n    if (item.destroyed) {\n      return;\n    }\n\n    var cachedStates = this.cachedStates;\n    var enabledStates = cachedStates.enabled;\n    var disabledStates = cachedStates.disabled;\n\n    if (enabled) {\n      checkCache(item, state, disabledStates);\n      cacheState(item, state, enabledStates);\n    } else {\n      checkCache(item, state, enabledStates);\n      cacheState(item, state, disabledStates);\n    }\n\n    if (timer) {\n      clearTimeout(timer);\n    }\n\n    timer = setTimeout(function () {\n      timer = null;\n\n      _this.updateGraphStates();\n    }, 16);\n  };\n  /**\n   * 批量更新 states，兼容 updateState，支持更新一个 state\n   *\n   * @param {Item} item\n   * @param {(string | string[])} states\n   * @param {boolean} enabled\n   * @memberof State\n   */\n\n\n  StateController.prototype.updateStates = function (item, states, enabled) {\n    var _this = this;\n\n    if (isString(states)) {\n      this.updateState(item, states, enabled);\n    } else {\n      states.forEach(function (state) {\n        _this.updateState(item, state, enabled);\n      });\n    }\n  };\n  /**\n   * 更新 states\n   *\n   * @memberof State\n   */\n\n\n  StateController.prototype.updateGraphStates = function () {\n    var states = this.graph.get('states');\n    var cachedStates = this.cachedStates;\n    each(cachedStates.disabled, function (val, key) {\n      if (states[key]) {\n        states[key] = states[key].filter(function (item) {\n          return val.indexOf(item) < 0 && !val.destroyed;\n        });\n      }\n    });\n    each(cachedStates.enabled, function (val, key) {\n      if (!states[key]) {\n        states[key] = val;\n      } else {\n        var map_1 = {};\n        states[key].forEach(function (item) {\n          if (!item.destroyed) {\n            map_1[item.get('id')] = true;\n          }\n        });\n        val.forEach(function (item) {\n          if (!item.destroyed) {\n            var id = item.get('id');\n\n            if (!map_1[id]) {\n              map_1[id] = true;\n              states[key].push(item);\n            }\n          }\n        });\n      }\n    });\n    this.graph.emit('graphstatechange', {\n      states: states\n    });\n    this.cachedStates = {\n      enabled: {},\n      disabled: {}\n    };\n  };\n\n  StateController.prototype.destroy = function () {\n    this.graph = null;\n    this.cachedStates = null;\n\n    if (timer) {\n      clearTimeout(timer);\n    }\n\n    timer = null;\n    this.destroyed = true;\n  };\n\n  return StateController;\n}();\n\nexport default StateController;","map":null,"metadata":{},"sourceType":"module"}