{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/asyncToGenerator\";\nimport _initializerDefineProperty from \"@babel/runtime/helpers/initializerDefineProperty\";\nimport _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _applyDecoratedDescriptor from \"@babel/runtime/helpers/applyDecoratedDescriptor\";\nimport _initializerWarningHelper from \"@babel/runtime/helpers/initializerWarningHelper\";\n\nvar _dec, _dec2, _dec3, _dec4, _dec5, _dec6, _dec7, _dec8, _dec9, _dec10, _dec11, _class, _class2, _descriptor, _descriptor2, _descriptor3, _descriptor4, _descriptor5, _descriptor6, _descriptor7, _descriptor8, _descriptor9, _class3, _temp;\n\nfunction _createForOfIteratorHelper(o, allowArrayLike) {\n  var it;\n\n  if (typeof Symbol === \"undefined\" || o[Symbol.iterator] == null) {\n    if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === \"number\") {\n      if (it) o = it;\n      var i = 0;\n\n      var F = function F() {};\n\n      return {\n        s: F,\n        n: function n() {\n          if (i >= o.length) return {\n            done: true\n          };\n          return {\n            done: false,\n            value: o[i++]\n          };\n        },\n        e: function e(_e) {\n          throw _e;\n        },\n        f: F\n      };\n    }\n\n    throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\");\n  }\n\n  var normalCompletion = true,\n      didErr = false,\n      err;\n  return {\n    s: function s() {\n      it = o[Symbol.iterator]();\n    },\n    n: function n() {\n      var step = it.next();\n      normalCompletion = step.done;\n      return step;\n    },\n    e: function e(_e2) {\n      didErr = true;\n      err = _e2;\n    },\n    f: function f() {\n      try {\n        if (!normalCompletion && it.return != null) it.return();\n      } finally {\n        if (didErr) throw err;\n      }\n    }\n  };\n}\n\nfunction _unsupportedIterableToArray(o, minLen) {\n  if (!o) return;\n  if (typeof o === \"string\") return _arrayLikeToArray(o, minLen);\n  var n = Object.prototype.toString.call(o).slice(8, -1);\n  if (n === \"Object\" && o.constructor) n = o.constructor.name;\n  if (n === \"Map\" || n === \"Set\") return Array.from(o);\n  if (n === \"Arguments\" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);\n}\n\nfunction _arrayLikeToArray(arr, len) {\n  if (len == null || len > arr.length) len = arr.length;\n\n  for (var i = 0, arr2 = new Array(len); i < len; i++) {\n    arr2[i] = arr[i];\n  }\n\n  return arr2;\n}\n\nimport { mat4 } from 'gl-matrix';\nimport { inject, injectable, named } from 'inversify';\nimport { IDENTIFIER } from '../../../identifier';\nimport { gl } from '../gl';\nexport var RenderPass = (_dec = injectable(), _dec2 = inject(IDENTIFIER.MeshComponentManager), _dec3 = inject(IDENTIFIER.GeometryComponentManager), _dec4 = inject(IDENTIFIER.MaterialComponentManager), _dec5 = inject(IDENTIFIER.CullableComponentManager), _dec6 = inject(IDENTIFIER.TransformComponentManager), _dec7 = inject(IDENTIFIER.HierarchyComponentManager), _dec8 = inject(IDENTIFIER.Systems), _dec9 = named(IDENTIFIER.FrameGraphSystem), _dec10 = inject(IDENTIFIER.RenderEngine), _dec11 = inject(IDENTIFIER.ResourcePool), _dec(_class = (_class2 = (_temp = _class3 = /*#__PURE__*/function () {\n  function RenderPass() {\n    var _this = this;\n\n    _classCallCheck(this, RenderPass);\n\n    _initializerDefineProperty(this, \"mesh\", _descriptor, this);\n\n    _initializerDefineProperty(this, \"geometry\", _descriptor2, this);\n\n    _initializerDefineProperty(this, \"material\", _descriptor3, this);\n\n    _initializerDefineProperty(this, \"cullable\", _descriptor4, this);\n\n    _initializerDefineProperty(this, \"transform\", _descriptor5, this);\n\n    _initializerDefineProperty(this, \"hierarchy\", _descriptor6, this);\n\n    _initializerDefineProperty(this, \"frameGraphSystem\", _descriptor7, this);\n\n    _initializerDefineProperty(this, \"engine\", _descriptor8, this);\n\n    _initializerDefineProperty(this, \"resourcePool\", _descriptor9, this);\n\n    this.modelCache = {};\n\n    this.setup = function (fg, passNode, pass) {\n      var output = fg.createRenderTarget(passNode, 'color buffer', {\n        width: 1,\n        height: 1,\n        usage: gl.RENDER_ATTACHMENT | gl.SAMPLED | gl.COPY_SRC\n      });\n      pass.data = {\n        output: passNode.write(fg, output)\n      };\n    };\n\n    this.execute = /*#__PURE__*/function () {\n      var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(fg, pass, views) {\n        var resourceNode, framebuffer, _iterator, _step, view, canvas;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                resourceNode = fg.getResourceNode(pass.data.output);\n                framebuffer = _this.resourcePool.getOrCreateResource(resourceNode.resource); // initialize model of each mesh\n\n                _iterator = _createForOfIteratorHelper(views);\n                _context.prev = 3;\n\n                _iterator.s();\n\n              case 5:\n                if ((_step = _iterator.n()).done) {\n                  _context.next = 11;\n                  break;\n                }\n\n                view = _step.value;\n                _context.next = 9;\n                return _this.initView(view);\n\n              case 9:\n                _context.next = 5;\n                break;\n\n              case 11:\n                _context.next = 16;\n                break;\n\n              case 13:\n                _context.prev = 13;\n                _context.t0 = _context[\"catch\"](3);\n\n                _iterator.e(_context.t0);\n\n              case 16:\n                _context.prev = 16;\n\n                _iterator.f();\n\n                return _context.finish(16);\n\n              case 19:\n                canvas = _this.engine.getCanvas();\n                framebuffer.resize({\n                  width: canvas.width,\n                  height: canvas.height\n                });\n\n                _this.engine.setScissor({\n                  enable: false\n                });\n\n                _this.engine.clear({\n                  framebuffer: framebuffer,\n                  color: views[0].getClearColor(),\n                  // TODO: use clearColor defined in view\n                  depth: 1\n                });\n\n                _this.engine.useFramebuffer(framebuffer, function () {\n                  var _iterator2 = _createForOfIteratorHelper(views),\n                      _step2;\n\n                  try {\n                    for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {\n                      var view = _step2.value; // must do rendering in a sync way\n\n                      _this.renderView(view);\n                    }\n                  } catch (err) {\n                    _iterator2.e(err);\n                  } finally {\n                    _iterator2.f();\n                  }\n                });\n\n              case 24:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, null, [[3, 13, 16, 19]]);\n      }));\n\n      return function (_x, _x2, _x3) {\n        return _ref.apply(this, arguments);\n      };\n    }();\n  }\n\n  _createClass(RenderPass, [{\n    key: \"renderView\",\n    value: function renderView(view) {\n      var scene = view.getScene();\n      var camera = view.getCamera(); // get VP matrix from camera\n\n      var viewMatrix = camera.getViewTransform();\n      var viewProjectionMatrix = mat4.multiply(mat4.create(), camera.getPerspective(), viewMatrix); // TODO: use cached planes if camera was not changed\n\n      camera.getFrustum().extractFromVPMatrix(viewProjectionMatrix);\n\n      var _view$getViewport = view.getViewport(),\n          x = _view$getViewport.x,\n          y = _view$getViewport.y,\n          width = _view$getViewport.width,\n          height = _view$getViewport.height;\n\n      this.engine.viewport({\n        x: x,\n        y: y,\n        width: width,\n        height: height\n      }); // this.engine.setScissor({\n      //   enable: true,\n      //   box: { x, y, width, height },\n      // });\n      // this.engine.clear({\n      //   // framebuffer,\n      //   color: [1, 1, 1, 1], // TODO: use clearColor defined in view\n      //   depth: 1,\n      // });\n\n      var _iterator3 = _createForOfIteratorHelper(scene.getEntities()),\n          _step3;\n\n      try {\n        for (_iterator3.s(); !(_step3 = _iterator3.n()).done;) {\n          var meshEntity = _step3.value;\n          this.renderMesh(meshEntity, {\n            camera: camera,\n            view: view,\n            viewMatrix: viewMatrix\n          });\n        }\n      } catch (err) {\n        _iterator3.e(err);\n      } finally {\n        _iterator3.f();\n      }\n    }\n  }, {\n    key: \"renderMesh\",\n    value: function renderMesh(meshEntity, _ref2) {\n      var camera = _ref2.camera,\n          view = _ref2.view,\n          viewMatrix = _ref2.viewMatrix;\n      var mesh = this.mesh.getComponentByEntity(meshEntity);\n\n      if (!mesh || !mesh.visible) {\n        return;\n      } // filter meshes with frustum culling\n      // if (!this.cullable.getComponentByEntity(meshEntity)?.visible) {\n      //   return;\n      // }\n\n\n      var material = mesh.material;\n      var geometry = mesh.geometry; // geometry 在自己的 System 中完成脏检查后的更新\n\n      if (!geometry || geometry.dirty || !material) {\n        return;\n      } // get model matrix from mesh\n\n\n      var transform = this.transform.getComponentByEntity(meshEntity);\n      var modelViewMatrix = mat4.multiply(mat4.create(), viewMatrix, transform.worldTransform);\n\n      var _view$getViewport2 = view.getViewport(),\n          width = _view$getViewport2.width,\n          height = _view$getViewport2.height; // set MVP matrix, other builtin uniforms @see https://threejs.org/docs/#api/en/renderers/webgl/WebGLProgram\n\n\n      material.setUniform({\n        projectionMatrix: camera.getPerspective(),\n        modelViewMatrix: modelViewMatrix,\n        modelMatrix: transform.worldTransform,\n        viewMatrix: viewMatrix,\n        cameraPosition: camera.getPosition(),\n        u_viewport: [width, height]\n      });\n\n      if (mesh.model) {\n        mesh.model.draw({\n          uniforms: material.uniforms.reduce(function (cur, prev) {\n            cur[prev.name] = prev.data;\n            return cur;\n          }, {})\n        });\n        material.uniforms.forEach(function (u) {\n          u.dirty = false;\n        });\n        material.dirty = false;\n      }\n    }\n  }, {\n    key: \"initMesh\",\n    value: function () {\n      var _initMesh = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(meshEntity, view) {\n        var mesh, material, geometry, modelCacheKey, _this$engine, createModel, createAttribute, modelInitializationOptions;\n\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                mesh = this.mesh.getComponentByEntity(meshEntity);\n\n                if (mesh) {\n                  _context2.next = 3;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\");\n\n              case 3:\n                material = mesh.material;\n                geometry = mesh.geometry;\n\n                if (!(!geometry || geometry.dirty || !material)) {\n                  _context2.next = 7;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\");\n\n              case 7:\n                if (mesh.model) {\n                  _context2.next = 24;\n                  break;\n                }\n\n                modelCacheKey = \"m-\".concat(material.entity, \"-g-\").concat(geometry.entity);\n\n                if (!this.modelCache[modelCacheKey]) {\n                  _context2.next = 12;\n                  break;\n                }\n\n                mesh.model = this.modelCache[modelCacheKey];\n                return _context2.abrupt(\"return\");\n\n              case 12:\n                material.setUniform({\n                  projectionMatrix: 1,\n                  modelViewMatrix: 1,\n                  modelMatrix: 1,\n                  viewMatrix: 1,\n                  cameraPosition: 1,\n                  u_viewport: 1\n                });\n                _this$engine = this.engine, createModel = _this$engine.createModel, createAttribute = _this$engine.createAttribute;\n                modelInitializationOptions = {\n                  vs: material.vertexShaderGLSL,\n                  fs: material.fragmentShaderGLSL,\n                  defines: material.defines,\n                  attributes: geometry.attributes.reduce(function (cur, prev) {\n                    if (prev.data && prev.buffer) {\n                      cur[prev.name] = createAttribute({\n                        buffer: prev.buffer,\n                        attributes: prev.attributes,\n                        arrayStride: prev.arrayStride,\n                        stepMode: prev.stepMode,\n                        divisor: prev.stepMode === 'vertex' ? 0 : 1\n                      });\n                    }\n\n                    return cur;\n                  }, {}),\n                  uniforms: material.uniforms.reduce(function (cur, prev) {\n                    cur[prev.name] = prev.data;\n                    return cur;\n                  }, {}),\n                  scissor: {\n                    enable: true,\n                    // @ts-ignore\n                    box: function box() {\n                      return view.getViewport();\n                    }\n                  }\n                };\n\n                if (material.cull) {\n                  modelInitializationOptions.cull = material.cull;\n                }\n\n                if (material.depth) {\n                  modelInitializationOptions.depth = material.depth;\n                }\n\n                if (material.blend) {\n                  modelInitializationOptions.blend = material.blend;\n                }\n\n                if (geometry.indicesBuffer) {\n                  modelInitializationOptions.elements = geometry.indicesBuffer;\n                }\n\n                if (geometry.maxInstancedCount) {\n                  modelInitializationOptions.instances = geometry.maxInstancedCount;\n                  modelInitializationOptions.count = geometry.vertexCount || 3;\n                }\n\n                _context2.next = 22;\n                return createModel(modelInitializationOptions);\n\n              case 22:\n                mesh.model = _context2.sent;\n                this.modelCache[modelCacheKey] = mesh.model;\n\n              case 24:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function initMesh(_x4, _x5) {\n        return _initMesh.apply(this, arguments);\n      }\n\n      return initMesh;\n    }()\n  }, {\n    key: \"initView\",\n    value: function () {\n      var _initView = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(view) {\n        var scene, _iterator4, _step4, meshEntity;\n\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                scene = view.getScene();\n                _iterator4 = _createForOfIteratorHelper(scene.getEntities());\n                _context3.prev = 2;\n\n                _iterator4.s();\n\n              case 4:\n                if ((_step4 = _iterator4.n()).done) {\n                  _context3.next = 10;\n                  break;\n                }\n\n                meshEntity = _step4.value;\n                _context3.next = 8;\n                return this.initMesh(meshEntity, view);\n\n              case 8:\n                _context3.next = 4;\n                break;\n\n              case 10:\n                _context3.next = 15;\n                break;\n\n              case 12:\n                _context3.prev = 12;\n                _context3.t0 = _context3[\"catch\"](2);\n\n                _iterator4.e(_context3.t0);\n\n              case 15:\n                _context3.prev = 15;\n\n                _iterator4.f();\n\n                return _context3.finish(15);\n\n              case 18:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this, [[2, 12, 15, 18]]);\n      }));\n\n      function initView(_x6) {\n        return _initView.apply(this, arguments);\n      }\n\n      return initView;\n    }()\n  }]);\n\n  return RenderPass;\n}(), _class3.IDENTIFIER = 'Render Pass', _temp), (_descriptor = _applyDecoratedDescriptor(_class2.prototype, \"mesh\", [_dec2], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor2 = _applyDecoratedDescriptor(_class2.prototype, \"geometry\", [_dec3], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor3 = _applyDecoratedDescriptor(_class2.prototype, \"material\", [_dec4], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor4 = _applyDecoratedDescriptor(_class2.prototype, \"cullable\", [_dec5], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor5 = _applyDecoratedDescriptor(_class2.prototype, \"transform\", [_dec6], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor6 = _applyDecoratedDescriptor(_class2.prototype, \"hierarchy\", [_dec7], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor7 = _applyDecoratedDescriptor(_class2.prototype, \"frameGraphSystem\", [_dec8, _dec9], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor8 = _applyDecoratedDescriptor(_class2.prototype, \"engine\", [_dec10], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n}), _descriptor9 = _applyDecoratedDescriptor(_class2.prototype, \"resourcePool\", [_dec11], {\n  configurable: true,\n  enumerable: true,\n  writable: true,\n  initializer: null\n})), _class2)) || _class);","map":null,"metadata":{},"sourceType":"module"}